eratohoReverse0.60 口上システム概要 第0版


0.はじめに
このテキストファイルはeratohoReverse0.60の口上システムについて概要を解説することを目的とする。
どちらかというとバリアント側から口上システムを見る説明になっている。
想定される主な読者は、パッチ作者、派生バリアント作者、コードの読めるデバッガの方である。
そのため、口上作者にはわかりにくい点が多々あるかもしれないが、理解して損はないと思う。
また、私の日本語が若干わかりにくいのは仕様である。
内容の正確性については残念ながら保証されない。悪しからず。


----------------------------------------------------------------------------------------------------

1.口上の種類について
口上の呼び出し側から見る口上の種類は以下の通り。
      <口上の種類>          <呼び出しタイミング>
    ・アクション口上        調教者行動時
    ・助手アクション口上    助手行動時
    ・脱衣アクション口上    脱衣行動時
    ・イベント口上          各種イベント発生時
    ・助手イベント口上      助手の各種イベント発生時
    ・刻印取得口上          調教対象の刻印取得時
    ・リアクション口上      調教対象の反応後
    ・媚薬等使用口上        媚薬/ローション等使用時
口上側から見る口上種類とは必ずしも一致しない。次章にて詳細な比較を行う。

----------------------------------------------------------------------------------------------------

2.口上を呼び出す関数と、実際に呼ばれる口上の関数について
以下に口上の種類と、呼び出しの為の関数、実際に呼ばれる口上の関数の対応を示す。
      <口上の種類>          <呼出関数>          <口上関数>
    ・アクション口上        @KOJO_ACT           @KOJO_ACT_KX1_Y1
    ・助手アクション口上    @KOJO_ACT_ASSI      @KOJO_ACT_ASSI_KX1_Y1
    ・脱衣アクション口上    @KOJO_DATUI         @KOJO_DATUI_KX1
                                                @KOJO_DATUI_ASSI_KX1
    ・イベント口上          @KOJO_EVENT         @KOJO_EVENT_KX1_Y1
    ・助手イベント口上      @KOJO_EVENT_ASSI    @KOJO_EVENT_ASSI_KX1_Y1
    ・刻印取得口上          @KOJO_MARK          @KOJO_MARK_KX1
    ・リアクション口上      @KOJO_REACT         @KOJO_REACT_KX1_Y1
                                                @KOJO_COM_KX1_Y1
    ・媚薬等使用口上        @KOJO_USE           @KOJO_USE_KX1
呼び出し側は直接口上関数をCALLすることはなく、呼出関数をCALLすることで間接的に口上関数を呼ぶ。
呼出関数はEVENT_K.ERBにて定義される。また、口上関数は各口上ファイルにて定義される。
呼び出し側から意識する必要は無いが、呼出関数から口上関数を呼び出す処理にはもう１クッションある。
対象限定口上では口上関数の名前が異なっており、それを呼び分ける層である。この解説は後程行う。
以下では、各口上毎のより詳しい解説を行う。


2-1.アクション口上
調教において調教者行動が行われる際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_ACT
この関数から呼ばれる口上関数は
    @KOJO_ACT_KX1_Y1
である。X1には調教者のキャラ番号、Y1には調教者行動番号が入る。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示したことを表す
    2…薬品使用を含んだアクション口上を表示したため、@KOJO_USEを呼ぶ必要が無いことを表す


2-2.助手アクション口上
調教において助手行動が行われる際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_ACT_ASSI
この関数から呼ばれる口上関数は
    @KOJO_ACT_ASSI_KX1_Y1
である。X1には助手のキャラ番号、Y1には助手行動番号が入る。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示したことを表す


2-3.脱衣アクション口上
調教において脱衣行動が行われる際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_DATUI
この関数から呼ばれる口上関数は
    @KOJO_DATUI_KX1			脱衣口上
    @KOJO_DATUI_ASSI_KX1	脱衣サポート口上
の２種類存在する。
@KOJO_DATUI_KX1のX1には調教者のキャラ番号、@KOJO_DATUI_ASSI_KX1のX1には助手のキャラ番号が入る。
通常、調教者が調教対象を脱がせた場合は@KOJO_DATUI_KX1(脱衣口上)が呼ばれ、
助手が調教対象を脱がせた場合は@KOJO_DATUI_ASSI_KX1(脱衣サポート口上)が呼ばれる。
ただし、助手が<マスター>の場合はこれが反転する。この時、一時的にTARGETとASSIの値が入れ替わる。
そのため、@KOJO_DATUI_KX1関数内では口上主は常にTARGETであり、
@KOJO_DATUI_ASSI_KX1関数内では口上主は常にASSIであることは保証される。
調教者自身が脱ぐ場合は、@KOJO_DATUI_KX1(脱衣口上)が呼ばれる。
ただし、調教者が調教対象を脱がせている場合は呼ばれない。
(既に調教者の脱衣口上/脱衣サポートを呼んでいるため、再度呼ぶことはしない)
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示したことを表す
余談だが、口上側でどちらかの一方の脱衣口上を記述したにも関わらず、
それが表示されなかった場合は<マスター>の存在を疑ってみる必要がある。
例えば口上主が<マスター>だと、@KOJO_DATUI_ASSI_KX1(脱衣サポート口上)が呼ばれることは無い。
口上作者もバリアント作者も、この仕様を頭の片隅に入れておいて損はない。


    --変数TEQUIPはキャラ変数？！--
    TEQUIPは本来キャラ変数なので、TEQUIP:MASTER:1のような記述が可能である。
    ただし、eratohoReverseではTEQUIP:1のような記述しか使われていない。
    これはTEQUIP:TARGET:1の省略形であり、MASTERの衣装といった本来MASTERが管理すべき情報も
    すべてTARGETにより管理されている。このことは通常あまり問題にならないが、
    脱衣アクション口上のように一時的にTARGETの値が変わるようなケースでは、
    TEQUIP:1のような記述は正常な値を参照できなくなってしまう。
    この辺りの処理に手を加える際は、上記の事柄を頭に入れておく必要がある。
    ※eratohoReverseではTARGET-ASSI入れ替えの関数があり、そこで必要な変数を含めた入れ替え処理を行っている


2-4.イベント口上
各種イベントの際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_EVENT(ARG,ARG:1,ARG:2)
引数の内容は以下の通り。
    ARG  …イベント番号
    ARG:1…イベント派生番号。派生が無いものについては、省略してもよい
    ARG:2…口上を呼び出すキャラ登録番号。省略した場合はTARGET
この関数から呼ばれる口上関数は
    @KOJO_EVENT_KX1_Y1(ARG)
である。X1にはキャラ番号(NO:(ARG:2))、Y1にはイベント番号(ARG)が入る。
また、引数ARGとしてイベント派生番号(ARG:1)が渡される。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示しており、呼び出し側でDRAWLINEが必要であることを表す
    2…口上を表示しており、呼び出し側で改行が必要であることを表す
    3…口上を表示しており、呼び出し側でDRAWLINEと改行の両方が必要であることを表す


2-5.助手イベント口上
助手に関する各種イベントの際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_EVENT_ASSI(ARG,ARG:1)
引数の内容は以下の通り。
    ARG  …イベント番号
    ARG:1…イベント派生番号。派生が無いものについては、省略してもよい
この関数から呼ばれる口上関数は
    @KOJO_EVENT_ASSI_KX1_Y1(ARG)
である。X1には助手のキャラ番号(NO:ASSI)、Y1にはイベント番号(ARG)が入る。
また、引数ARGとしてイベント派生番号(ARG:1)が渡される。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示しており、呼び出し側でDRAWLINEが必要であることを表す
    2…口上を表示しており、呼び出し側で改行が必要であることを表す
    3…口上を表示しており、呼び出し側でDRAWLINEと改行の両方が必要であることを表す


2-6.刻印取得口上
調教対象が刻印を取得した際に表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_MARK(ARG,ARG:1,ARG:2,ARG:3,ARG:4)
引数の内容は以下の通り。
    ARG  …取得した苦痛刻印のレベル。取得していない場合は0
    ARG:1…取得した快楽刻印のレベル。取得していない場合は0
    ARG:2…取得した屈服刻印のレベル。取得していない場合は0
    ARG:3…取得した反抗刻印のレベル。取得していない場合は0
    ARG:4…取得したトラウマのレベル。取得していない場合は0
この関数から呼ばれる口上関数は
    @KOJO_MARK_KX1(ARG,ARG:1,ARG:2,ARG:3,ARG:4)
である。X1には調教者のキャラ番号が入る。
また、引数ARG～ARG:4には@KOJO_MARKに渡された引数がそのまま渡される。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…口上を表示しなかったことを表す
    1…口上を表示したことを表す


2-7.リアクション口上
調教対象の反応に応じて表示される口上である。
呼び出す際は以下の関数を使用する。
    @KOJO_REACT
この関数から呼ばれる口上関数は
    @KOJO_REACT_KX1_Y1  調教者行動別に定義される、個別リアクション
    @KOJO_COM_KX1_Y1    調教対象の反応別に定義される、汎用リアクション
の２種類存在する。
@KOJO_REACT_KX1_Y1のX1には調教者のキャラ番号、Y1には調教者行動番号(TFLAG:90)が入る。
@KOJO_COM_KX1_Y1のX1には調教者のキャラ番号、Y1には調教対象の反応番号(SELECTCOM)が入る。
この関数はまず、@KOJO_REACT_KX1_Y1の呼び出しを試みる。
これにより口上が表示されなかった場合、@KOJO_COM_KX1_Y1を呼び出す。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…いずれの口上も表示しなかったことを表す
    1…口上を表示したことを表す


2-8.媚薬等使用口上
調教者により媚薬やローション等が使われた際に表示される口上である。
(助手がこれらを使用する場合は、助手アクション口上を用いる)
呼び出す際は以下の関数を使用する。
    @KOJO_USE
この関数の呼び出しに際し、アクション口上の呼び出し結果を参照する必要がある。
この関数から呼ばれる口上関数は
    @KOJO_USE_KX1
である。X1には調教者のキャラ番号が入る。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…いずれの口上も表示しなかったことを表す
    1…口上を表示したことを表す

----------------------------------------------------------------------------------------------------

3.対象限定口上の呼び出しと、口上呼び出しの排他処理について
※システムの大まかな動きを理解するだけなら本章を読み飛ばしても構わない
呼出関数から口上関数が呼ばれる際に１クッションあると前述したが、EVENT_K.ERBの@KOJO_CALLがそれである。
この関数では、対象限定口上の呼び出しや口上呼び出しの排他処理に関する処理を行う。


3-1.対象限定口上の種類
対象限定口上とは、口上の適用範囲として調教対象(MASTER)を特定条件下に限定するタイプの口上である。
MASTERが条件に当てはまらない場合、その口上は呼ばれない。
限定には以下の種類がある。
        <限定系統>  <限定の種類>    <接頭語>    <呼出条件>
    高  キャラ限定  オトコあなた    MALEYOU     調教対象があなたで、素質[オトコ]がある
                    ふたなりあなた  TWINYOU     調教対象があなたで、素質[ふたなり]がある
    ↑              ペニス付あなた  PENISYOU    調教対象があなたで、素質[オトコ][ふたなり]のいずれかがある
    優              女あなた        FEMALEYOU   調教対象があなたで、素質[オトコ]がない
    先              指定キャラ限定  NO_KX1      調教対象が指定のキャラ
    順  性別限定    オトコ限定      MALE        調教対象に素質[オトコ]がある
    位              ふたなり限定    TWIN        調教対象に素質[ふたなり]がある
    ↓              ペニス付限定    PENIS       調教対象に素質[オトコ][ふたなり]のいずれかがある
                    女限定          FEMALE      調教対象に素質[オトコ]がない
    低  限定なし    通常            (なし)      条件無し
以下は具体的な例である(アクション口上)
    オトコあなた限定            @KOJO_MALEYOU_ACT_KX1_Y1
    あなた限定(指定キャラ限定)  @KOJO_NO0_ACT_KX1_Y1
    女限定                      @KOJO_FEMALE_ACT_KX1_Y1
    限定なし                    @KOJO_ACT_KX1_Y1
なお、X1には調教者のキャラ番号、Y1には調教者行動番号が入る。


3-2.関数@KOJO_CALLの概要
@KOJO_CALLは各呼出関数から、実際の口上関数を呼ぶためにCALLされる。
実際の口上関数はここからCALLされる。(厳密にはTRYCALLFORM命令を用いて呼び出しを試みている、というのが正しい)
引数の内容は以下の通り。
    ARGS …呼び出す口上関数名の後半部分
    ARG  …口上主の登録番号。省略された場合はTARGET
    ARG:1…呼び出す口上関数の引数の数
    ARG:2…呼び出す口上関数に渡す引数1
    ARG:3…          〃          引数2
    ARG:4…          〃          引数3
    ARG:5…          〃          引数4
    ARG:6…          〃          引数5
現状、口上関数の引数の数は0/1/5のいずれかである。
戻り値RESULTは、口上を表示したかどうかを表す値である。
    0…いずれの口上も表示しなかったことを表す
    1…口上を表示したことを表す


3-3.関数@KOJO_CALLの処理の流れ(概要)
    １．キャラ限定の口上の呼び出しを試みる
    ２．排他処理１(キャラ限定口上と、その他の口上間の不整合を防ぐ)
    ３．性別限定の口上の呼びだしを試みる
    ４．排他処理２(性別限定口上と、通常の口上間の不整合を防ぐ)
    ５．通常の口上(限定なし)の呼び出しを試みる


3-4.排他システムの動き
排他システムとは、口上を共存させた場合に不都合な口上補完を防ぐ仕組みである。
あるキャラについて、通常の口上を含め、各種の限定口上を共存させることが可能である。
その際、限定口上で未定義の口上に関しては通常の口上(あるいは限定の緩い他の限定口上)により補完される。
が、その際に問題になるのが口上間の整合性である。
整合性如何によっては、補完しない方がマシというケースも考えられる。
排他指定された場合、系統が異なり優先度が低い口上の呼び出しをスキップする。
系統が同じ場合は排他することは出来ない。
排他を行うかどうかの指定は、口上関数@KOJO_Y1_EXCLUSION_KX1にて行われる。
X1にはキャラ番号、Y1には限定種別ごとの接頭語が入る。
なお、デフォルトでは排他は行っていない。
口上作者は、口上が補完される/補完に用いられるケースがあるということを頭の片隅に入れておくとよい。
(ただし、補完に用いられる前提で口上を書くというのは大変かもしれないので程々に)
限定口上を書こうと考えている口上作者は、このような補完/排他機能もあるということを知っておくと良い。


3-5.まとめ
つまり、こんな感じです。
…──────┬──────────┬─────…
  バリアント  │    口上システム    │口上ファイル
  ﾊﾞﾘｱﾝﾄの関数→呼出関数→@KOJO_CALL→口上関数    
              │                    │            
…──────┴──────────┴─────…
あるいは、こーんな感じ。             ／＼￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣￣
                                   ／    ＼
                                 ／口上関数＼
                               ／            ＼
                             ／@KOJO_DATUI_KX1 ＼
                           ／@KOJO_DATUI_ASSI_KX1＼
                         ／@KOJO_EVENT_ASSI_KX1_Y1 ＼           口上ファイル
                       ／@KOJO_USE_KX1 @KOJO_MARK_KX1＼
                     ／     @KOJO_ACT_ASSI_KX1_Y1      ＼
                   ／@KOJO_COM_KX1_Y1 @KOJO_EVENT_KX1_Y1 ＼
                 ／  @KOJO_ACT_KX1_Y1 @KOJO_REACT_KX1_Y1   ＼
               ／──────────────────────＼────────
             ／                   @KOJO_CALL                   ＼
           ／──────────────────────────＼    口上
         ／                        呼出関数                        ＼  システム
       ／     @KOJO_ACT @KOJO_ACT_ASSI @KOJO_DATUI @KOJO_EVENT       ＼
     ／       @KOJO_EVENT_ASSI @KOJO_MARK @KOJO_REACT @KOJO_USE        ＼
   ／──────────────────────────────────＼──
 ／                               バリアント                               ＼
～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～

----------------------------------------------------------------------------------------------------

4.口上の文字色と表示位置について
※システムの大まかな動きを理解するだけなら本章を読み飛ばしても構わない
口上の文字色は口上関数@KOJO_COLOR_KX1で指定される。
なお、この関数はキャラを通じて単一である。限定口上毎に色が異なると、整合性が取れなくなるためである。
これは各呼出関数から、@KOJO_COLORを通じて呼び出される。
直接呼び出すことは無いので、あまり注意する必要はないだろう。
ただし、各呼出関数にてRESETCOLOR命令が使われていることは意識すべきポイントかもしれない。
口上作者には色指定を行うことをオススメしたい。デフォルトで使用される口上色は地味な灰色である。
表示位置については、助手の口上は右揃えになるように作られている。
呼び出しに際して注意する点は無いが、バリアント側で地の文などを記述する際は注意が必要かもしれない。
口上作者は、助手口上を書く際に折り返しが発生しないよう気を配る必要があるかもしれない。
右揃えで折り返すと見栄えがよろしくない場合が多く、改行した方がよい結果を得られるように思う。

----------------------------------------------------------------------------------------------------

5.おわりに
ぱの人へ…もし見ていたら、勝手に変なの書いてごめんなさい。間違っていたらもっとごめんなさい。
もっとReverse系の裾野が広がるといいですね。
そうなれば、相互にノウハウやらパッチやらをやりとりしたり出来るかも。


文責／eratohoReverseのまとめパッチつくったり修正パッチつくったりした人
      あるいはeraSQスレ7のID:yKFvr4bA


くつした、おいしい。 さとりさま、だいすき